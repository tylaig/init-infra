#!/bin/bash

# =============================================================================
# Script de Configuração de Infraestrutura - Ubuntu 22.04
# Versão: 2.7.1
# Otimizado para Ubuntu 22.04 LTS
# =============================================================================

# Cores para output
amarelo="\e[33m"
verde="\e[32m"
branco="\e[97m"
bege="\e[93m"
vermelho="\e[91m"
reset="\e[0m"

# =============================================================================
# Funções de Interface
# =============================================================================

nome_aviso(){

clear
echo ""
echo -e "$amarelo===================================================================================================$reset"
echo -e "$amarelo=                                                                                                 $amarelo=$reset"
echo -e "$amarelo=                     $branco  █████╗     ██╗   ██╗    ██╗    ███████╗     ██████╗                       $amarelo=$reset"
echo -e "$amarelo=                     $branco ██╔══██╗    ██║   ██║    ██║    ██╔════╝    ██╔═══██╗                      $amarelo=$reset"
echo -e "$amarelo=                     $branco ███████║    ██║   ██║    ██║    ███████╗    ██║   ██║                      $amarelo=$reset"
echo -e "$amarelo=                     $branco ██╔══██║    ╚██╗ ██╔╝    ██║    ╚════██║    ██║   ██║                      $amarelo=$reset"
echo -e "$amarelo=                     $branco ██║  ██║     ╚████╔╝     ██║    ███████║    ╚██████╔╝                      $amarelo=$reset"
echo -e "$amarelo=                     $branco ╚═╝  ╚═╝      ╚═══╝      ╚═╝    ╚══════╝     ╚═════╝                       $amarelo=$reset"
echo -e "$amarelo=                                                                                                 $amarelo=$reset"
echo -e "$amarelo===================================================================================================$reset"
echo ""
echo ""
}

nome_atualizando(){
    clear
    echo ""
    echo -e "$amarelo===================================================================================================$reset"
    echo -e "$amarelo=                                                                                                 $amarelo=$reset"
    echo -e "$amarelo=    $branco  █████╗ ████████╗██╗   ██╗ █████╗ ██╗     ██╗███████╗ █████╗ ███╗   ██╗██████╗  ██████╗     $amarelo=$reset"
    echo -e "$amarelo=    $branco ██╔══██╗╚══██╔══╝██║   ██║██╔══██╗██║     ██║╚══███╔╝██╔══██╗████╗  ██║██╔══██╗██╔═══██╗    $amarelo=$reset"
    echo -e "$amarelo=    $branco ███████║   ██║   ██║   ██║███████║██║     ██║  ███╔╝ ███████║██╔██╗ ██║██║  ██║██║   ██║    $amarelo=$reset"
    echo -e "$amarelo=    $branco ██╔══██║   ██║   ██║   ██║██╔══██║██║     ██║ ███╔╝  ██╔══██║██║╚██╗██║██║  ██║██║   ██║    $amarelo=$reset"
    echo -e "$amarelo=    $branco ██║  ██║   ██║   ╚██████╔╝██║  ██║███████╗██║███████╗██║  ██║██║ ╚████║██████╔╝╚██████╔╝    $amarelo=$reset"
    echo -e "$amarelo=    $branco ╚═╝  ╚═╝   ╚═╝    ╚═════╝ ╚═╝  ╚═╝╚══════╝╚═╝╚══════╝╚═╝  ╚═╝╚═╝  ╚═══╝╚═════╝  ╚═════╝     $amarelo=$reset"
    echo -e "$amarelo=                                                                                                 $amarelo=$reset"
    echo -e "$amarelo===================================================================================================$reset"
    echo ""
    echo ""
}
nome_iniciando(){
    clear
    echo ""
    echo -e "$amarelo===================================================================================================$reset"
    echo -e "$amarelo=                                                                                                 $amarelo=$reset"
    echo -e "$amarelo=                  $branco ██╗███╗   ██╗██╗ ██████╗██╗ █████╗ ███╗   ██╗██████╗  ██████╗                 $amarelo=$reset"
    echo -e "$amarelo=                  $branco ██║████╗  ██║██║██╔════╝██║██╔══██╗████╗  ██║██╔══██╗██╔═══██╗                $amarelo=$reset"
    echo -e "$amarelo=                  $branco ██║██╔██╗ ██║██║██║     ██║███████║██╔██╗ ██║██║  ██║██║   ██║                $amarelo=$reset"
    echo -e "$amarelo=                  $branco ██║██║╚██╗██║██║██║     ██║██╔══██║██║╚██╗██║██║  ██║██║   ██║                $amarelo=$reset"
    echo -e "$amarelo=                  $branco ██║██║ ╚████║██║╚██████╗██║██║  ██║██║ ╚████║██████╔╝╚██████╔╝                $amarelo=$reset"
    echo -e "$amarelo=                  $branco ╚═╝╚═╝  ╚═══╝╚═╝ ╚═════╝╚═╝╚═╝  ╚═╝╚═╝  ╚═══╝╚═════╝  ╚═════╝                 $amarelo=$reset"
    echo -e "$amarelo=                                              v. 2.7.1                                           $amarelo=$reset"
    echo -e "$amarelo===================================================================================================$reset"
    echo ""
    echo ""
}

nome_verificando(){
    clear
    echo ""
    echo -e "$amarelo===================================================================================================$reset"
    echo -e "$amarelo=                                                                                                 $amarelo=$reset"
    echo -e "$amarelo=       $branco ██╗   ██╗███████╗██████╗ ██╗███████╗██╗ ██████╗ █████╗ ███╗   ██╗██████╗  ██████╗       $amarelo=$reset"
    echo -e "$amarelo=       $branco ██║   ██║██╔════╝██╔══██╗██║██╔════╝██║██╔════╝██╔══██╗████╗  ██║██╔══██╗██╔═══██╗      $amarelo=$reset"
    echo -e "$amarelo=       $branco ██║   ██║█████╗  ██████╔╝██║█████╗  ██║██║     ███████║██╔██╗ ██║██║  ██║██║   ██║      $amarelo=$reset"
    echo -e "$amarelo=       $branco ╚██╗ ██╔╝██╔══╝  ██╔══██╗██║██╔══╝  ██║██║     ██╔══██║██║╚██╗██║██║  ██║██║   ██║      $amarelo=$reset"
    echo -e "$amarelo=       $branco  ╚████╔╝ ███████╗██║  ██║██║██║     ██║╚██████╗██║  ██║██║ ╚████║██████╔╝╚██████╔╝      $amarelo=$reset"
    echo -e "$amarelo=       $branco   ╚═══╝  ╚══════╝╚═╝  ╚═╝╚═╝╚═╝     ╚═╝ ╚═════╝╚═╝  ╚═╝╚═╝  ╚═══╝╚═════╝  ╚═════╝       $amarelo=$reset"
    echo -e "$amarelo=                                                                                                 $amarelo=$reset"
    echo -e "$amarelo===================================================================================================$reset"
    echo ""
    echo ""
}
# =============================================================================
# Funções Utilitárias
# =============================================================================

desc_ver(){
    echo -e "                            Este script é otimizado para$amarelo Ubuntu 22.04 LTS$branco.$reset"
    echo -e "                            Compatível também com$amarelo Ubuntu 20.04$branco e$amarelo Debian 11$branco.$reset"
    echo ""
}

# Função para executar comandos com verificação de erro
executar_comando() {
    local comando="$1"
    local descricao="$2"
    local contador="$3"
    
    if eval "$comando" > /dev/null 2>&1; then
        echo "${contador}/12 - [ OK ] - ${descricao}"
    else
        echo "${contador}/12 - [ OFF ] - ${descricao}"
    fi
}

# =============================================================================
# Verificações Iniciais
# =============================================================================

clear
nome_verificando
echo "Aguarde enquanto verificamos algumas informações."
sleep 1

# Verifica se está usando Ubuntu 22.04, 20.04 ou Debian 11
if ! grep -q 'PRETTY_NAME="Ubuntu 22.04' /etc/os-release && ! grep -q 'PRETTY_NAME="Ubuntu 20.04' /etc/os-release && ! grep -q 'PRETTY_NAME="Debian GNU/Linux 11' /etc/os-release; then
    nome_aviso
    desc_ver
    sleep 5
    clear
    nome_verificando
fi

# Verifica se o usuário é root
if [ "$(id -u)" -ne 0 ]; then
    echo "Este script precisa ser executado como root. Executando sudo su..."
    sudo su
fi

# Verifica se o usuário está no diretório /root/
if [ "$PWD" != "/root" ]; then
    echo "Mudando para o diretório /root/"
    cd /root || exit
fi

# =============================================================================
# Instalação de Pacotes - Otimizado para Ubuntu 22.04
# =============================================================================

nome_iniciando 

# Lista de pacotes essenciais para Ubuntu 22.04
pacotes=(
    "apt update"
    "apt install -y software-properties-common"
    "apt install -y apt-transport-https"
    "apt install -y ca-certificates"
    "apt install -y curl"
    "apt install -y wget"
    "apt install -y gnupg"
    "apt install -y lsb-release"
    "apt install -y jq"
    "apt install -y git"
    "apt install -y python3"
    "apt install -y neofetch"
)

# Descrições dos pacotes
descricoes=(
    "Atualizando lista de pacotes"
    "Instalando software-properties-common"
    "Instalando apt-transport-https"
    "Instalando ca-certificates"
    "Instalando curl"
    "Instalando wget"
    "Instalando gnupg"
    "Instalando lsb-release"
    "Instalando jq"
    "Instalando Git"
    "Instalando Python3"
    "Instalando neofetch"
)

# Instala os pacotes
for i in "${!pacotes[@]}"; do
    executar_comando "${pacotes[$i]}" "${descricoes[$i]}" "$((i+1))"
    echo ""
done

# =============================================================================
# Download e Execução do SetupMSAPP
# =============================================================================

# Verifica se o arquivo SetupMSAPP já existe e remove
if [ -e "SetupMSAPP" ]; then
    rm SetupMSAPP
fi

# Baixa o script SetupMSAPP
curl -sSL https://raw.githubusercontent.com/tylaig/init-infra/main/SetupMSAPP -o SetupMSAPP
if [ $? -eq 0 ]; then
    echo "Download concluído com sucesso!"
    chmod +x SetupMSAPP
    echo "Executando SetupMSAPP..."
    ./SetupMSAPP
else
    echo "Erro: Não foi possível baixar o SetupMSAPP"
    echo "Verifique sua conexão com a internet e tente novamente."
    sleep 5
fi

# =============================================================================
# Limpeza Final
# =============================================================================

# Atualiza o sistema uma última vez
apt update > /dev/null 2>&1
apt upgrade -y > /dev/null 2>&1

# Remove o arquivo temporário
if [ -e "SetupMSAPP" ]; then
    rm SetupMSAPP
fi

clear
echo -e "${verde}Setup concluído com sucesso!${reset}"
echo -e "${amarelo}Sistema configurado e pronto para uso.${reset}"